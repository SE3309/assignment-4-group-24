<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../styles/output.css">
  <title>Clients and Jobs</title>
</head>
<body class="h-screen bg-gray-100 flex">
  <aside class="w-64 bg-gray-900 text-white flex flex-col">
    <div class="flex items-center justify-center h-16 border-b border-gray-700">
      <img src="https://tailwindui.com/plus/img/logos/mark.svg?color=indigo&shade=600" alt="Logo" class="h-8 w-auto">
    </div>
    <nav class="flex-1 px-2 py-4 space-y-2">
      <a href="dashboard.html" class="flex items-center px-4 py-2 text-sm font-medium rounded-lg bg-gray-800">
        <svg class="w-5 h-5 mr-3 text-gray-800 dark:text-white" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path fill-rule="evenodd" d="M11.293 3.293a1 1 0 0 1 1.414 0l6 6 2 2a1 1 0 0 1-1.414 1.414L19 12.414V19a2 2 0 0 1-2 2h-3a1 1 0 0 1-1-1v-3h-2v3a1 1 0 0 1-1 1H7a2 2 0 0 1-2-2v-6.586l-.293.293a1 1 0 0 1-1.414-1.414l2-2 6-6Z" clip-rule="evenodd"/>
        </svg>        
        Dashboard
      </a>
      <a href="dispatchers.html" class="flex items-center px-4 py-2 text-sm font-medium rounded-lg hover:bg-gray-800">
        <svg class="w-5 h-5 mr-3 text-gray-800 dark:text-white" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path fill-rule="evenodd" d="M16 19h4a1 1 0 0 0 1-1v-1a3 3 0 0 0-3-3h-2m-2.236-4a3 3 0 1 0 0-4M3 18v-1a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v1a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1Zm8-10a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
        </svg>  
        Dispatchers
      </a>
      <a href="clients.html" class="flex items-center px-4 py-2 text-sm font-medium rounded-lg hover:bg-gray-800">
        <svg class="w-5 h-5 mr-3 text-gray-800 dark:text-white" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path fill-rule="evenodd" d="M16 19h4a1 1 0 0 0 1-1v-1a3 3 0 0 0-3-3h-2m-2.236-4a3 3 0 1 0 0-4M3 18v-1a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v1a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1Zm8-10a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
        </svg>  
        Clients
      </a>
      <a href="jobs.html" class="flex items-center px-4 py-2 text-sm font-medium rounded-lg hover:bg-gray-800">
        <svg class="w-5 h-5 mr-3 text-gray-800 dark:text-white" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path fill-rule="evenodd" d="M10 2a3 3 0 0 0-3 3v1H5a3 3 0 0 0-3 3v2.382l1.447.723.005.003.027.013.12.056c.108.05.272.123.486.212.429.177 1.056.416 1.834.655C7.481 13.524 9.63 14 12 14c2.372 0 4.52-.475 6.08-.956.78-.24 1.406-.478 1.835-.655a14.028 14.028 0 0 0 .606-.268l.027-.013.005-.002L22 11.381V9a3 3 0 0 0-3-3h-2V5a3 3 0 0 0-3-3h-4Zm5 4V5a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v1h6Zm6.447 7.894.553-.276V19a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-5.382l.553.276.002.002.004.002.013.006.041.02.151.07c.13.06.318.144.557.242.478.198 1.163.46 2.01.72C7.019 15.476 9.37 16 12 16c2.628 0 4.98-.525 6.67-1.044a22.95 22.95 0 0 0 2.01-.72 15.994 15.994 0 0 0 .707-.312l.041-.02.013-.006.004-.002.001-.001-.431-.866.432.865ZM12 10a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2H12Z"/>
        </svg>  
        All Jobs
      </a>
      <a href="drivers.html" class="flex items-center px-4 py-2 text-sm font-medium rounded-lg hover:bg-gray-800">
        <svg class="w-5 h-5 mr-3 text-gray-800 dark:text-white" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path fill-rule="evenodd" d="M16 19h4a1 1 0 0 0 1-1v-1a3 3 0 0 0-3-3h-2m-2.236-4a3 3 0 1 0 0-4M3 18v-1a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v1a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1Zm8-10a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
        </svg>  
        Drivers
      </a>
      <a href="trucks.html" class="flex items-center px-4 py-2 text-sm font-medium rounded-lg hover:bg-gray-800">
        <svg class="w-5 h-5 mr-3 text-gray-800 dark:text-white" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path fill-rule="evenodd" d="M13 7h6l2 4m-8-4v8H9m4-8V6c0-.26522-.1054-.51957-.2929-.70711C12.5196 5.10536 12.2652 5 12 5H4c-.26522 0-.51957.10536-.70711.29289C3.10536 5.48043 3 5.73478 3 6v9h2m14 0h2v-4m0 0h-5M8 8.66669V10l1.5 1.5m10 5c0 1.3807-1.1193 2.5-2.5 2.5s-2.5-1.1193-2.5-2.5S15.6193 14 17 14s2.5 1.1193 2.5 2.5Zm-10 0C9.5 17.8807 8.38071 19 7 19s-2.5-1.1193-2.5-2.5S5.61929 14 7 14s2.5 1.1193 2.5 2.5Z"/>
        </svg>  
        Trucks
      </a>
      <a href="expenses.html" class="flex items-center px-4 py-2 text-sm font-medium rounded-lg hover:bg-gray-800">
        <svg class="w-5 h-5 mr-3 text-gray-800 dark:text-white" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M9 15a6 6 0 1 1 12 0 6 6 0 0 1-12 0Zm3.845-1.855a2.4 2.4 0 0 1 1.2-1.226 1 1 0 0 1 1.992-.026c.426.15.809.408 1.111.749a1 1 0 1 1-1.496 1.327.682.682 0 0 0-.36-.213.997.997 0 0 1-.113-.032.4.4 0 0 0-.394.074.93.93 0 0 0 .455.254 2.914 2.914 0 0 1 1.504.9c.373.433.669 1.092.464 1.823a.996.996 0 0 1-.046.129c-.226.519-.627.94-1.132 1.192a1 1 0 0 1-1.956.093 2.68 2.68 0 0 1-1.227-.798 1 1 0 1 1 1.506-1.315.682.682 0 0 0 .363.216c.038.009.075.02.111.032a.4.4 0 0 0 .395-.074.93.93 0 0 0-.455-.254 2.91 2.91 0 0 1-1.503-.9c-.375-.433-.666-1.089-.466-1.817a.994.994 0 0 1 .047-.134Zm1.884.573.003.008c-.003-.005-.003-.008-.003-.008Zm.55 2.613s-.002-.002-.003-.007a.032.032 0 0 1 .003.007ZM4 14a1 1 0 0 1 1 1v4a1 1 0 1 1-2 0v-4a1 1 0 0 1 1-1Zm3-2a1 1 0 0 1 1 1v6a1 1 0 1 1-2 0v-6a1 1 0 0 1 1-1Zm6.5-8a1 1 0 0 1 1-1H18a1 1 0 0 1 1 1v3a1 1 0 1 1-2 0v-.796l-2.341 2.049a1 1 0 0 1-1.24.06l-2.894-2.066L6.614 9.29a1 1 0 1 1-1.228-1.578l4.5-3.5a1 1 0 0 1 1.195-.025l2.856 2.04L15.34 5h-.84a1 1 0 0 1-1-1Z"/>
        </svg>  
        Expenses
      </a>
      <a href="documents.html" class="flex items-center px-4 py-2 text-sm font-medium rounded-lg hover:bg-gray-800">
        <svg class="w-5 h-5 mr-3 text-gray-800 dark:text-white" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M6 16v-3h.375a.626.626 0 0 1 .625.626v1.749a.626.626 0 0 1-.626.625H6Zm6-2.5a.5.5 0 1 1 1 0v2a.5.5 0 0 1-1 0v-2Z"/>
          <path fill-rule="evenodd" d="M11 7V2h7a2 2 0 0 1 2 2v5h1a1 1 0 0 1 1 1v9a1 1 0 0 1-1 1h-1a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2H3a1 1 0 0 1-1-1v-9a1 1 0 0 1 1-1h6a2 2 0 0 0 2-2Zm7.683 6.006 1.335-.024-.037-2-1.327.024a2.647 2.647 0 0 0-2.636 2.647v1.706a2.647 2.647 0 0 0 2.647 2.647H20v-2h-1.335a.647.647 0 0 1-.647-.647v-1.706a.647.647 0 0 1 .647-.647h.018ZM5 11a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h1.376A2.626 2.626 0 0 0 9 15.375v-1.75A2.626 2.626 0 0 0 6.375 11H5Zm7.5 0a2.5 2.5 0 0 0-2.5 2.5v2a2.5 2.5 0 0 0 5 0v-2a2.5 2.5 0 0 0-2.5-2.5Z" clip-rule="evenodd"/>
          <path d="M9 7V2.221a2 2 0 0 0-.5.365L4.586 6.5a2 2 0 0 0-.365.5H9Z"/>
        </svg>  
        Documents
      </a>
    </nav>
    <div class="px-4 py-2 border-t border-gray-700">
      <a href="settings.html" class="flex items-center text-sm font-medium rounded-lg text-gray-400 hover:text-white">
        <svg class="w-5 h-5 mr-3 text-gray-800 dark:text-white" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path fill-rule="evenodd" d="M17 10v1.126c.367.095.714.24 1.032.428l.796-.797 1.415 1.415-.797.796c.188.318.333.665.428 1.032H21v2h-1.126c-.095.367-.24.714-.428 1.032l.797.796-1.415 1.415-.796-.797a3.979 3.979 0 0 1-1.032.428V20h-2v-1.126a3.977 3.977 0 0 1-1.032-.428l-.796.797-1.415-1.415.797-.796A3.975 3.975 0 0 1 12.126 16H11v-2h1.126c.095-.367.24-.714.428-1.032l-.797-.796 1.415-1.415.796.797A3.977 3.977 0 0 1 15 11.126V10h2Zm.406 3.578.016.016c.354.358.574.85.578 1.392v.028a2 2 0 0 1-3.409 1.406l-.01-.012a2 2 0 0 1 2.826-2.83ZM5 8a4 4 0 1 1 7.938.703 7.029 7.029 0 0 0-3.235 3.235A4 4 0 0 1 5 8Zm4.29 5H7a4 4 0 0 0-4 4v1a2 2 0 0 0 2 2h6.101A6.979 6.979 0 0 1 9 15c0-.695.101-1.366.29-2Z" clip-rule="evenodd"/>
        </svg>  
        Settings
      </a>
    </div>
  </aside>
  

  <!-- Main Content -->
  <div class="flex-1 flex flex-col">
    <!-- Header -->
    <header class="flex items-center justify-between px-6 py-4 h-16 bg-white border-b border-gray-300">
      <h1 class="text-xl font-bold">Clients and Jobs</h1>
      <div class="flex items-center space-x-4">
        <div class="flex items-center justify-center w-10 h-10 bg-indigo-500 text-white rounded-full">A</div>
        <button class="px-4 py-2 bg-red-500 text-white text-sm font-medium rounded-lg hover:bg-red-600">Logout</button>
      </div>
    </header>

    <!-- Content -->
    <main class="flex-1 p-6 bg-gray-100">
      <div class="bg-white shadow rounded-lg p-6">
        <!-- Add Client Form -->
        <form id="addClientForm" class="mb-6">
          <div class="grid grid-cols-4 gap-4">
            <input type="text" name="F_name" placeholder="First Name" class="border rounded-lg px-4 py-2" required />
            <input type="text" name="L_name" placeholder="Last Name" class="border rounded-lg px-4 py-2" required />
            <input type="email" name="Email" placeholder="Email" class="border rounded-lg px-4 py-2" required />
            <input type="text" name="Phone_No" placeholder="Phone Number" class="border rounded-lg px-4 py-2" required />
          </div>
          <button type="submit" class="mt-4 px-6 py-2 bg-green-500 text-white rounded-lg">Add Client</button>
        </form>

        <!-- Clients Table -->
        <table class="min-w-full bg-white border border-gray-300 rounded-lg">
          <thead>
            <tr class="bg-gray-200 text-gray-700">
              <th class="py-3 px-4 text-left">Client Name</th>
              <th class="py-3 px-4 text-left">Email</th>
              <th class="py-3 px-4 text-left">Phone Number</th>
              <th class="py-3 px-4 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="clientsTable" class="divide-y divide-gray-200">
            <!-- Dynamic Content Will Be Inserted Here -->
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Inline JavaScript -->
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const clientsTable = document.getElementById("clientsTable");
      const addClientForm = document.getElementById("addClientForm");

      // Fetch and populate clients
      async function fetchClients() {
        try {
          const response = await fetch("http://localhost:3000/api/clients");
          if (!response.ok) throw new Error("Failed to fetch clients");
          const clientsData = await response.json();
          populateClientsTable(clientsData);
        } catch (error) {
          console.error("Error fetching clients:", error);
        }
      }

      // Populate clients table
      function populateClientsTable(clientsData) {
        clientsTable.innerHTML = ""; // Clear existing rows
        clientsData.forEach((client) => {
          const clientRow = document.createElement("tr");
          clientRow.className = "bg-gray-100 border-b";

          clientRow.innerHTML = `
            <td class="py-3 px-4 font-bold text-lg">${client.F_name} ${client.L_name}</td>
            <td class="py-3 px-4">${client.Email}</td>
            <td class="py-3 px-4">${client.Phone_No}</td>
            <td class="py-3 px-4">
              <button class="px-4 py-2 bg-blue-500 text-white rounded edit-client" data-id="${client.Client_ID}">Edit</button>
              <button class="px-4 py-2 bg-red-500 text-white rounded delete-client" data-id="${client.Client_ID}">Delete</button>
              <button class="px-4 py-2 bg-green-500 text-white rounded view-jobs" data-id="${client.Client_ID}">View Jobs</button>
            </td>
          `;

          const jobsRow = document.createElement("tr");
          jobsRow.className = "hidden bg-gray-50";
          jobsRow.innerHTML = `
            <td colspan="4" class="py-3 px-4">
              <ul id="jobs-${client.Client_ID}" class="list-disc pl-5"></ul>
            </td>
          `;

          clientsTable.appendChild(clientRow);
          clientsTable.appendChild(jobsRow);

          // Attach event listeners to buttons
          attachEventListeners(client, clientRow, jobsRow);
        });
      }

      function attachEventListeners(client, clientRow, jobsRow) {
        // View Jobs
        clientRow.querySelector(".view-jobs").addEventListener("click", () => toggleJobs(client.Client_ID, jobsRow));

        // Edit Client
        clientRow.querySelector(".edit-client").addEventListener("click", () => editClient(client.Client_ID));

        // Delete Client
        clientRow.querySelector(".delete-client").addEventListener("click", () => deleteClient(client.Client_ID));
      }

      async function toggleJobs(clientId, jobsRow) {
        if (jobsRow.classList.contains("hidden")) {
          try {
            const response = await fetch(`http://localhost:3000/api/clients/${clientId}/jobs`);
            if (!response.ok) throw new Error("Failed to fetch jobs");
            const jobsData = await response.json();

            const jobsList = jobsRow.querySelector(`#jobs-${clientId}`);
            jobsList.innerHTML = jobsData
              .map((job) => `<li>Job ID: ${job.Job_ID}, Type: ${job.Job_Type}</li>`)
              .join("");
            jobsRow.classList.remove("hidden");
          } catch (error) {
            console.error("Error fetching jobs:", error);
          }
        } else {
          jobsRow.classList.add("hidden");
        }
      }

      async function addClient(event) {
        event.preventDefault();
        const formData = new FormData(addClientForm);
        const newClient = {
          F_name: formData.get("F_name"),
          L_name: formData.get("L_name"),
          Email: formData.get("Email"),
          Phone_No: formData.get("Phone_No"),
        };
        try {
          const response = await fetch("http://localhost:3000/api/clients", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newClient),
          });
          if (!response.ok) throw new Error("Failed to add client");
          fetchClients();
          addClientForm.reset();
        } catch (error) {
          console.error("Error adding client:", error);
        }
      }

      async function editClient(clientId) {
        const newDetails = prompt("Enter new details: FirstName, LastName, Email, PhoneNo");
        if (!newDetails) return;

        const [F_name, L_name, Email, Phone_No] = newDetails.split(", ");
        try {
          const response = await fetch(`http://localhost:3000/api/clients/${clientId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ F_name, L_name, Email, Phone_No }),
          });
          if (!response.ok) throw new Error("Failed to update client");
          fetchClients();
        } catch (error) {
          console.error("Error updating client:", error);
        }
      }

      async function deleteClient(clientId) {
        if (!confirm("Are you sure you want to delete this client?")) return;
        try {
          const response = await fetch(`http://localhost:3000/api/clients/${clientId}`, {
            method: "DELETE",
          });
          if (!response.ok) throw new Error("Failed to delete client");
          fetchClients();
        } catch (error) {
          console.error("Error deleting client:", error);
        }
      }

      addClientForm.addEventListener("submit", addClient);
      fetchClients();
    });
  </script>
</body>
</html>
